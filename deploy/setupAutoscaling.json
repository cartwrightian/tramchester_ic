{
	"AWSTemplateFormatVersion":"2010-09-09",
		"Description":"Launch template for tramchester web server INTIIAL Create only, use .update afterwards",
	"Parameters":{
	"env":{ "Type":"String" }, 
	"vpc":{ "Type":"String" }, 
	"build":{ "Type":"String" }, 
	"webSg":{ "Type":"String", "Default":"sg-0f3b7b98e89323c46" },
	"ami":{ "Type":"String", "Default":"ami-09f6caae59175ba13" },
	"baseUrl":{ "Type":"String", "Default":"https://s3-eu-west-1.amazonaws.com" },
	"bucketName":{"Type":"String", "Default":"tramchesternewdist"},
	"bootstrapCloudInit":{"Type":"String", "Default":"cloudInitAWSLinux.txt"},
	"bootstrapWebScript":{"Type":"String", "Default":"setupTramWebServerAWSLinux.sh"},
	"keypairname": { "Type" : "String" , "Default" : "tramchester_new" },
	"TFGMAPIKEY": { "Type" : "String", "Description" : "::ENV", "NoEcho" : "true"},
	"instanceProfile":{"Type":"String", "Default":"tramchester_ec2_role"} },
	"Mappings":{
	"environMap":{
		"Dev":{ "keyName":"tramchester2", "webSize":"t3.medium" },
		"UAT":{ "keyName":"tramchester2", "webSize":"t3.medium" },
		"ProdGreen":{ "keyName":"tramchester2", "webSize":"t3.medium" },
		"ProdBlue":{ "keyName":"tramchester2", "webSize":"t2.micro" }
		}
	},
	"Resources":{
	"LaunchTemplate": {
		"Type" : "AWS::EC2::LaunchTemplate",
		"Properties" : {
			"LaunchTemplateData" : {
				"KeyName":{ "Ref":"keypairname" },
				"InstanceType":{
					"Fn::FindInMap":[
						"environMap", {
							"Ref":"env"
						}, "webSize"
					]
				}, "ImageId":{
					"Ref":"ami"
				}, "IamInstanceProfile":{
					"Name": { "Ref":"instanceProfile" }
				}, "UserData":{
					"Fn::Base64":{
						"Fn::Join":[
							"", [
								"#include", "\n",
								{"Ref":"baseUrl"}, "/", {"Ref":"bucketName"}, "/dist/", {"Ref":"build"}, "/",
								{"Ref":"bootstrapCloudInit"}, "\n",
								{"Ref":"baseUrl"}, "/", {"Ref":"bucketName"}, "/dist/", {"Ref":"build"}, "/",
								{"Ref":"bootstrapWebScript"}, "\n",
								"# ENV=", {"Ref":"env"}, "\n",
								"# BUILD=", {"Ref":"build"}, "\n",
								"# BUCKET=", {"Ref":"bucketName"}, "\n",
								"# TFGMAPIKEY=", {"Ref":"TFGMAPIKEY"}, "\n"
							]
						]
					}
				}, "SecurityGroupIds":[
					{
						"Ref":"webSg"
					}
				], "TagSpecifications": [
					{
						"ResourceType": "instance",
						"Tags": [
							{
								"Key": "Name",
								"Value": {
									"Fn::Join": [
										"_",
										[
											"webserver",
											{
												"Ref": "env"
											},
											{
												"Ref": "build"
											}
										]
									]
								}
							},
							{
								"Key": "CFN_ASSIST_TYPE",
								"Value": "web"
							},
							{
								"Key": "ENV",
								"Value": {
									"Ref": "env"
								}
							},
							{
								"Key": "BUILD",
								"Value": {
									"Ref": "build"
								}
							}
						]
					}
				]
			},
			"LaunchTemplateName" : {
				"Fn::Join":[ "_", ["tramchesterLaunchTemplate", {"Ref":"env"}]]
			}
		}
	}

}, "Outputs":{}
}
